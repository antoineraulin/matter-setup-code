stages:
  - test
  - security
  - lint
  - fuzz

# --- GLOBAL CONFIGURATION ---

# Cache Rust artifacts to speed up builds
cache:
  paths:
    - .cargo/
    - target/
    - fuzz/target/

# Include GitLab's official security templates here (Top Level)
include:
  - template: Security/Secret-Detection.gitlab-ci.yml
  - template: Security/SAST.gitlab-ci.yml

# --- JOBS ---

# 1. Standard Unit Tests
test:unit:
  stage: test
  image: rust:latest
  script:
    - cargo test --verbose

# 2. Rust-Specific Dependency Scanning
audit:dependencies:
  stage: security
  image: rust:latest
  before_script:
    - cargo install cargo-audit
  script:
    - cargo audit
  allow_failure: false

# 3. Rust-Specific Linting (Clippy)
clippy:lint:
  stage: lint
  image: rust:latest
  before_script:
    - rustup component add clippy
  script:
    - cargo clippy -- -D warnings
  allow_failure: false

# 4. Fuzz Testing
fuzz:smoke-test:
  stage: fuzz
  image: rustlang/rust:nightly
  variables:
    FUZZ_TIME: "60" 
  before_script:
    - cargo install cargo-fuzz
  script:
    # Initialize fuzz folder if not exists (for CI robustness)
    - cargo fuzz init || true 
    - cargo fuzz run fuzz_target_1 -- -max_total_time=$FUZZ_TIME

# --- OVERRIDES FOR INCLUDED TEMPLATES ---

# The SAST template defines a job named 'sast'. 
# We reference it here ONLY to override the stage to 'security' 
# (it defaults to 'test' in the template).
sast:
  stage: security
  variables:
    SAST_EXCLUDED_PATHS: "target/, .cargo/"

# The Secret Detection template defines 'secret_detection'.
# We override it to ensure it runs in the 'security' stage.
secret_detection:
  stage: security